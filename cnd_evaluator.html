<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sPyTial Evaluator REPL</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #1e1e1e; color: #d4d4d4; }
        .container { max-width: 800px; margin: 0 auto; }
        .repl { background: #1e1e1e; border: 1px solid #333; padding: 10px; border-radius: 5px; }
        .repl-output { font-family: monospace; white-space: pre-wrap; margin-bottom: 10px; max-height: 300px; overflow-y: auto; }
        .repl-input { font-family: monospace; width: 100%; padding: 10px; border: 1px solid #333; border-radius: 5px; background: #252526; color: #d4d4d4; }
        .repl-input:focus { outline: none; border-color: #007acc; }
        .success { color: #b5cea8; }
        .error { color: #f48771; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/cnd-core@1.1.9-beta.6/dist/browser/cnd-core-complete.global.js"></script>
</head>
<body>
    <div class="containe-fluidr">
        <div class="repl">
            <div id="repl-output" class="repl-output"></div>
            <input id="repl-input" class="repl-input" placeholder="Enter your expression here..." />
        </div>
    </div>

    <script>
        // Embedded data passed from the server
        const jsonData = `{"atoms": [{"id": "n1", "type": "str", "label": "test", "type_hierarchy": ["str", "object"]}, {"id": "n3", "type": "int", "label": "1", "type_hierarchy": ["int", "object"]}, {"id": "n4", "type": "int", "label": "2", "type_hierarchy": ["int", "object"]}, {"id": "n5", "type": "int", "label": "3", "type_hierarchy": ["int", "object"]}, {"id": "n2", "type": "list", "label": "list[3]", "type_hierarchy": ["list", "object"]}, {"id": "n0", "type": "dict", "label": "dict{2}", "type_hierarchy": ["dict", "object"]}], "relations": [{"id": "0", "name": "0", "types": ["object", "object"], "tuples": [{"atoms": ["n2", "n3"], "types": ["list", "int"]}]}, {"id": "1", "name": "1", "types": ["object", "object"], "tuples": [{"atoms": ["n2", "n4"], "types": ["list", "int"]}]}, {"id": "2", "name": "2", "types": ["object", "object"], "tuples": [{"atoms": ["n2", "n5"], "types": ["list", "int"]}]}, {"id": "name", "name": "name", "types": ["object", "object"], "tuples": [{"atoms": ["n0", "n1"], "types": ["dict", "str"]}]}, {"id": "items", "name": "items", "types": ["object", "object"], "tuples": [{"atoms": ["n0", "n2"], "types": ["dict", "list"]}]}], "types": [{"_": "type", "id": "str", "types": ["str", "object"], "atoms": [{"_": "atom", "id": "n1", "type": "str"}], "meta": {"builtin": true}}, {"_": "type", "id": "int", "types": ["int", "object"], "atoms": [{"_": "atom", "id": "n3", "type": "int"}, {"_": "atom", "id": "n4", "type": "int"}, {"_": "atom", "id": "n5", "type": "int"}], "meta": {"builtin": true}}, {"_": "type", "id": "list", "types": ["list", "object"], "atoms": [{"_": "atom", "id": "n2", "type": "list"}], "meta": {"builtin": false}}, {"_": "type", "id": "dict", "types": ["dict", "object"], "atoms": [{"_": "atom", "id": "n0", "type": "dict"}], "meta": {"builtin": false}}]}`;

        // Parse the JSON data
        let parsedData;
        try {
            parsedData = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
        } catch (error) {
            console.error('Failed to parse JSON data:', error);
            appendToReplOutput(`<span class="error">Error: Failed to parse JSON data: ${error.message}</span>`);
        }

        // Initialize the evaluator
        let evaluator;
        try {
            const dataInstance = new CndCore.JSONDataInstance(parsedData);
            const evaluationContext = { sourceData: dataInstance };
            evaluator = new CndCore.SGraphQueryEvaluator();
            evaluator.initialize(evaluationContext);
        } catch (error) {
            console.error('Failed to initialize evaluator:', error);
            appendToReplOutput(`<span class="error">Error: Failed to initialize evaluator: ${error.message}</span>`);
        }

        // Command history
        const commandHistory = [];
        let historyIndex = -1;

        // Handle REPL input
        const replInput = document.getElementById('repl-input');
        replInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const expression = replInput.value.trim();
                if (expression) {
                    commandHistory.push(expression);
                    historyIndex = commandHistory.length;
                    evaluateExpression(expression);
                    replInput.value = '';
                }
            } else if (event.key === 'ArrowUp') {
                if (historyIndex > 0) {
                    historyIndex--;
                    replInput.value = commandHistory[historyIndex];
                }
            } else if (event.key === 'ArrowDown') {
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    replInput.value = commandHistory[historyIndex];
                } else {
                    replInput.value = '';
                }
            }
        });

// Function to evaluate the expression
    function evaluateExpression(expression) {
        try {
            appendToReplOutput(`<span class="success">> ${expression}</span>`);
            const result = evaluator.evaluate(expression);

            // Use prettyPrint if available
            if (result && typeof result.prettyPrint === 'function') {
                const prettyResult = result.prettyPrint();
                appendToReplOutput(`<span class="success">${prettyResult}</span>`);
            } else {
                appendToReplOutput(`<span class="success">${JSON.stringify(result, null, 2)}</span>`);
            }
        } catch (error) {
            console.error('Evaluation failed:', error);
            appendToReplOutput(`<span class="error">Error: ${error.message}</span>`);
        }
    }

        // Function to append output to the REPL
        function appendToReplOutput(content) {
            const replOutput = document.getElementById('repl-output');
            replOutput.innerHTML += `${content}<br>`;
            replOutput.scrollTop = replOutput.scrollHeight; // Auto-scroll to the bottom
        }
    </script>
</body>
</html>