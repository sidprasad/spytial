<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sPyTial Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #graph-container {
            width: 800px;
            height: 600px;
            border: 2px solid #007acc;
            border-radius: 8px;
            margin: 20px auto;
        }
    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cnd-core/dist/browser/cnd-core-complete.global.js"></script>

<body>
    <!-- WebCola sPyTial Graph Element -->
    <webcola-cnd-graph 
        id="graph-container"
        width="800" 
        height="600"
        layoutFormat="default"
        aria-label="Interactive graph visualization">
    </webcola-cnd-graph>
    <div id="error-message" ></div>

    <script>
        // Embedded data passed from the server
        const cndSpec = `constraints: []
directives: []
`;
        const jsonData = `{"atoms": [{"id": "n1", "type": "int", "label": "1"}, {"id": "n3", "type": "int", "label": "2"}, {"id": "n4", "type": "NoneType", "label": "None"}, {"id": "n2", "type": "Node", "label": "Node"}, {"id": "n6", "type": "int", "label": "3"}, {"id": "n5", "type": "Node", "label": "Node"}, {"id": "n0", "type": "Node", "label": "Node"}], "relations": [{"id": "val", "name": "val", "types": ["object", "object"], "tuples": [{"atoms": ["n2", "n3"], "types": ["Node", "int"]}, {"atoms": ["n5", "n6"], "types": ["Node", "int"]}, {"atoms": ["n0", "n1"], "types": ["Node", "int"]}]}, {"id": "left", "name": "left", "types": ["object", "object"], "tuples": [{"atoms": ["n2", "n4"], "types": ["Node", "NoneType"]}, {"atoms": ["n5", "n4"], "types": ["Node", "NoneType"]}, {"atoms": ["n0", "n2"], "types": ["Node", "Node"]}]}, {"id": "right", "name": "right", "types": ["object", "object"], "tuples": [{"atoms": ["n2", "n4"], "types": ["Node", "NoneType"]}, {"atoms": ["n5", "n4"], "types": ["Node", "NoneType"]}, {"atoms": ["n0", "n5"], "types": ["Node", "Node"]}]}]}`;

        /**
         * Load and render the graph using the webcola-cnd-graph custom element
         */
        async function loadGraph() {
            const graphElement = document.getElementById('graph-container');
            
            // Check if CnD Core is available
            if (typeof CndCore === 'undefined') {
                console.error('CnD Core library is not available');
                showError('CnD Core library failed to load. The visualization cannot be displayed.');
                return;
            }
            
            try {
        console.log('Starting graph rendering...');
        console.log('sPyTial Spec:', cndSpec);
                console.log('JSON Data:', jsonData.substring(0, 200) + '...');
                
                // Parse JSON data if it's a string
                let parsedData;
                try {
                    parsedData = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
                } catch (parseError) {
                    throw new Error(`Failed to parse JSON data: ${parseError.message}`);
                }
                
                // Create a data instance from the JSON data
                const dataInstance = new CndCore.JSONDataInstance(parsedData);
                console.log('Data instance created successfully');

                // Initialize the evaluation context
                const evaluationContext = { sourceData: dataInstance };
                const sgqEvaluator = new CndCore.SGraphQueryEvaluator();
                sgqEvaluator.initialize(evaluationContext);
                console.log('Evaluation context initialized');

                // Parse the CND specification
                const layoutSpec = CndCore.parseLayoutSpec(cndSpec);
                console.log('Layout spec parsed');

                // Generate the layout
                const layoutInstance = new CndCore.LayoutInstance(layoutSpec, sgqEvaluator, 0, true);
                const layoutResult = layoutInstance.generateLayout(dataInstance, {});
                const instanceLayout = layoutResult.layout;
                console.log('Layout generated');

                // Render the graph
                await graphElement.renderLayout(instanceLayout);
                console.log('Graph rendered successfully!');
                
            } catch (error) {
                console.error('Error rendering graph:', error);
                showError(`Error rendering graph: ${error.message}`);
            }
        }

        /**
         * Display an error message in the error-message div.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.innerHTML = `
                    <div style="color: red; padding: 10px; border: 1px solid red; background-color: #ffe6e6; margin-top: 10px;">
                        <h3>Error</h3>
                        <p>${message}</p>
                    </div>
                `;
            } else {
                console.error('Error div not found. Error message:', message);
            }
        }

        // Auto-load when page loads
        window.addEventListener('load', loadGraph);
    </script>
</body>
</html>